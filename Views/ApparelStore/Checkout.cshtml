@{
    ViewData["Title"] = "Checkout";
    var appId = ViewBag.AppId;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Apparel Store</title>
    <link rel="stylesheet" href="~/apparel-store/store.css" />
</head>
<body>
    <header class="store-header">
        <div class="container">
            <h1><a href="@Url.Action("Index", new { appId })">Apparel Store</a></h1>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">Checkout</h1>

        <div class="checkout-container">
            <div class="checkout-form">
                <h2>Shipping Information</h2>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="shippingName">Full Name *</label>
                        <input type="text" id="shippingName" name="shippingName" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="shippingEmail">Email</label>
                        <input type="email" id="shippingEmail" name="shippingEmail" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="shippingPhone">Phone</label>
                        <input type="tel" id="shippingPhone" name="shippingPhone" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="shippingAddress">Address *</label>
                        <input type="text" id="shippingAddress" name="shippingAddress" class="form-control" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="shippingCity">City *</label>
                            <input type="text" id="shippingCity" name="shippingCity" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="shippingState">State/Province *</label>
                            <input type="text" id="shippingState" name="shippingState" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="shippingZipCode">ZIP/Postal Code *</label>
                            <input type="text" id="shippingZipCode" name="shippingZipCode" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="shippingCountry">Country *</label>
                            <input type="text" id="shippingCountry" name="shippingCountry" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customerNotes">Order Notes (Optional)</label>
                        <textarea id="customerNotes" name="customerNotes" class="form-control" rows="3"></textarea>
                    </div>

                    <div id="checkoutMessage" class="message"></div>

                    <div class="form-actions">
                        <a href="@Url.Action("Cart", new { appId })" class="btn btn-secondary">Back to Cart</a>
                        <button type="submit" class="btn btn-primary" id="checkoutBtn">Place Order</button>
                    </div>
                </form>
            </div>

            <div class="order-summary">
                <h2>Order Summary</h2>
                <div id="orderItems">
                    <!-- Items will be loaded here -->
                </div>

                <div class="summary-totals">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="orderSubtotal">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                </div>

                <div class="payment-info">
                    <p><strong>Payment Method:</strong> Bitcoin (via BTCPayServer)</p>
                    <p>You will be redirected to complete payment after placing your order.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="store-footer">
        <div class="container">
            <p>Powered by BTCPayServer | Pay with Bitcoin</p>
        </div>
    </footer>

    <script>
        const appId = '@appId';
        const apiBasePath = '/apps/' + appId + '/apparel/api';
    </script>
    <script src="~/apparel-store/cart.js"></script>
    <script>
        // Load order summary
        document.addEventListener('DOMContentLoaded', async function() {
            const cart = getCart();

            if (cart.length === 0) {
                window.location.href = '@Url.Action("Cart", new { appId })';
                return;
            }

            // Fetch product details
            const response = await fetch(apiBasePath + '/cart/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cart)
            });

            const items = await response.json();
            displayOrderSummary(items);
        });

        function displayOrderSummary(items) {
            const container = document.getElementById('orderItems');
            container.innerHTML = '';

            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'summary-item';
                itemElement.innerHTML = `
                    <div class="summary-item-details">
                        <strong>${item.productName}</strong>
                        <p>${item.color} / ${item.size} Ã— ${item.quantity}</p>
                    </div>
                    <div class="summary-item-price">
                        $${(item.price * item.quantity).toFixed(2)}
                    </div>
                `;
                container.appendChild(itemElement);
            });

            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('orderSubtotal').textContent = '$' + total.toFixed(2);
            document.getElementById('orderTotal').textContent = '$' + total.toFixed(2);
        }

        // Handle form submission
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const cart = getCart();
            if (cart.length === 0) {
                showMessage('Your cart is empty', 'error');
                return;
            }

            const formData = new FormData(e.target);
            const orderData = {
                items: cart,
                shippingName: formData.get('shippingName'),
                shippingEmail: formData.get('shippingEmail'),
                shippingPhone: formData.get('shippingPhone'),
                shippingAddress: formData.get('shippingAddress'),
                shippingCity: formData.get('shippingCity'),
                shippingState: formData.get('shippingState'),
                shippingZipCode: formData.get('shippingZipCode'),
                shippingCountry: formData.get('shippingCountry'),
                customerNotes: formData.get('customerNotes')
            };

            const checkoutBtn = document.getElementById('checkoutBtn');
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'Processing...';

            try {
                const response = await fetch(apiBasePath + '/order/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    throw new Error('Failed to create order');
                }

                const result = await response.json();

                // Clear cart
                clearCart();

                // TODO: Redirect to BTCPay invoice
                showMessage('Order created successfully! Order ID: ' + result.orderId, 'success');

                // For now, redirect to home after 2 seconds
                setTimeout(() => {
                    window.location.href = '@Url.Action("Index", new { appId })';
                }, 2000);

            } catch (error) {
                console.error('Checkout error:', error);
                showMessage('Failed to process order. Please try again.', 'error');
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'Place Order';
            }
        });

        function showMessage(text, type) {
            const messageEl = document.getElementById('checkoutMessage');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type;
            messageEl.style.display = 'block';
        }
    </script>
</body>
</html>
