@model BTCPayServer.Plugins.ApparelStore.Models.Product
@{
    ViewData["Title"] = Model.Name;
    var appId = ViewBag.AppId;
    var colors = Model.Variants.Select(v => v.Color).Distinct().ToList();
    var sizes = Model.Variants.Select(v => v.Size).Distinct().ToList();
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Apparel Store</title>
    <link rel="stylesheet" href="~/apparel-store/store.css" />
</head>
<body>
    <header class="store-header">
        <div class="container">
            <h1><a href="@Url.Action("Index", new { appId })">Apparel Store</a></h1>
            <div class="header-actions">
                <a href="@Url.Action("Cart", new { appId })" class="cart-link">
                    <span class="cart-icon">ðŸ›’</span>
                    <span class="cart-count" id="cartCount">0</span>
                </a>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="product-detail">
            <div class="product-gallery">
                @if (Model.Images.Any())
                {
                    <div class="main-image">
                        <img id="mainImage" src="@Model.Images.First().ImageUrl" alt="@Model.Name" />
                    </div>
                    @if (Model.Images.Count() > 1)
                    {
                        <div class="thumbnail-gallery">
                            @foreach (var image in Model.Images)
                            {
                                <img src="@image.ImageUrl"
                                     alt="@Model.Name"
                                     class="thumbnail @(image == Model.Images.First() ? "active" : "")"
                                     data-color="@image.ColorVariant"
                                     onclick="changeMainImage(this)" />
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="main-image product-image-placeholder">
                        <span>No Image Available</span>
                    </div>
                }
            </div>

            <div class="product-details">
                <h1>@Model.Name</h1>

                <p class="product-price" id="displayPrice">
                    @Model.BasePrice.ToString("C") @Model.Currency
                </p>

                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <div class="product-description">
                        @Model.Description
                    </div>
                }

                @if (Model.Variants.Any())
                {
                    <form id="productForm" class="product-form">
                        @if (colors.Count > 1)
                        {
                            <div class="form-group">
                                <label for="colorSelect">Color:</label>
                                <div class="color-selector">
                                    @foreach (var color in colors)
                                    {
                                        var colorVariant = Model.Variants.First(v => v.Color == color);
                                        <label class="color-option">
                                            <input type="radio"
                                                   name="color"
                                                   value="@color"
                                                   data-hex="@colorVariant.ColorHex"
                                                   required />
                                            <span class="color-swatch"
                                                  style="background-color: @(colorVariant.ColorHex ?? "#cccccc")">
                                            </span>
                                            <span class="color-name">@color</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        }

                        @if (sizes.Count > 0)
                        {
                            <div class="form-group">
                                <label for="sizeSelect">Size:</label>
                                <select id="sizeSelect" name="size" class="form-control" required>
                                    <option value="">Select Size</option>
                                    @foreach (var size in sizes)
                                    {
                                        <option value="@size">@size</option>
                                    }
                                </select>
                            </div>
                        }

                        <div class="form-group">
                            <label for="quantity">Quantity:</label>
                            <input type="number"
                                   id="quantity"
                                   name="quantity"
                                   value="1"
                                   min="1"
                                   max="10"
                                   class="form-control" />
                        </div>

                        <button type="button" id="addToCartBtn" class="btn btn-primary btn-large" onclick="addToCart()">
                            Add to Cart
                        </button>

                        <div id="message" class="message"></div>
                    </form>
                }
                else
                {
                    <div class="alert alert-warning">
                        This product is currently unavailable.
                    </div>
                }
            </div>
        </div>
    </main>

    <footer class="store-footer">
        <div class="container">
            <p>Powered by BTCPayServer | Pay with Bitcoin</p>
        </div>
    </footer>

    <script>
        const productData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new {
            id = Model.Id,
            name = Model.Name,
            basePrice = Model.BasePrice,
            currency = Model.Currency,
            variants = Model.Variants.Select(v => new {
                id = v.Id,
                size = v.Size,
                color = v.Color,
                colorHex = v.ColorHex,
                priceAdjustment = v.PriceAdjustment,
                isAvailable = v.IsAvailable
            }),
            images = Model.Images.Select(i => new {
                url = i.ImageUrl,
                colorVariant = i.ColorVariant
            })
        }));
    </script>
    <script src="~/apparel-store/cart.js"></script>
    <script src="~/apparel-store/product.js"></script>
</body>
</html>
